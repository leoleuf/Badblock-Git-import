package fr.xmalware.badblock.hub.listeners;

import java.util.Arrays;

import org.bukkit.Bukkit;
import org.bukkit.GameMode;
import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.inventory.InventoryAction;
import org.bukkit.event.inventory.InventoryClickEvent;
import org.bukkit.inventory.ItemStack;
import org.bukkit.inventory.meta.ItemMeta;

import com.google.common.io.ByteArrayDataOutput;
import com.google.common.io.ByteStreams;

import fr.badblock.gameapi.players.BadblockPlayer;
import fr.xmalware.badblock.hub.BadBlockHub;
import fr.xmalware.badblock.hub.inventories.abstracts.actions.ItemAction;
import fr.xmalware.badblock.hub.inventories.abstracts.inventories.CustomInventory;
import fr.xmalware.badblock.hub.inventories.abstracts.items.CustomItem;
import fr.xmalware.badblock.hub.inventories.hubchanger.HubChangerInventory;
import fr.xmalware.badblock.hub.inventories.join.PlayerCustomInventory;
import fr.xmalware.badblock.hub.listeners.vipzone.RaceListener;
import fr.xmalware.badblock.hub.objects.HubPlayer;
import fr.xmalware.badblock.hub.rabbit.Hub;

public class InventoryClickListener extends _HubListener {

	@EventHandler
	public void onInventoryClick(InventoryClickEvent event) {
		if (!(event.getWhoClicked() instanceof Player))
			return;
		BadblockPlayer player = (BadblockPlayer) event.getWhoClicked();

		// Bypass en gm
		if (player.getGameMode().equals(GameMode.CREATIVE))
			return;

		// Cancel
		HubPlayer lobbyPlayer = HubPlayer.get(player);
		event.setCancelled(!player.hasAdminMode());

		ItemStack itemStack = event.getCurrentItem();
		if (itemStack == null)
			return;
		InventoryAction inventoryAction = event.getAction();
		ItemAction itemAction = ItemAction.get(inventoryAction);
		if (lobbyPlayer.getCurrentInventory() != null) {
			for (CustomItem customItem : lobbyPlayer.getCurrentInventory().getItems().values()) {
				if (customItem == null)
					continue;
				if (!customItem.getActions().contains(itemAction))
					continue;
				if (!customItem.toItemStack(player).isSimilar(itemStack))
					continue;
				if (lobbyPlayer.hasSpam(player))
					return;
				if (RaceListener.racePlayers.containsKey(player)) {
					player.sendTranslatedMessage("hub.race.youcannotdothatinrace");
					return;
				}
				if (customItem.getNeededPermission() != null && !player.hasPermission(customItem.getNeededPermission())) {
					player.sendTranslatedMessage(customItem.getErrorNeededPermission());
					return;
				}
				customItem.onClick(player, itemAction, null);
			}
		}
		for (PlayerCustomInventory playerCustomInventory : Arrays.asList(PlayerCustomInventory.values())) {
			CustomItem customItem = playerCustomInventory.getCustomItem();
			if (customItem == null)
				continue;
			if (!customItem.getActions().contains(itemAction))
				continue;
			if (!customItem.toItemStack(player).equals(itemStack.getItemMeta().getDisplayName()))
				continue;
			if (lobbyPlayer.hasSpam(player))
				return;
			if (RaceListener.racePlayers.containsKey(player)) {
				player.sendTranslatedMessage("hub.race.youcannotdothatinrace");
				return;
			}
			if (customItem.getNeededPermission() != null && !player.hasPermission(customItem.getNeededPermission())) {
				player.sendTranslatedMessage(customItem.getErrorNeededPermission());
				return;
			}
			customItem.onClick(player, itemAction, null);
		}
		if (event.getInventory().getName().equals(player.getTranslatedMessage(CustomInventory.get(HubChangerInventory.class).getName())[0])) {
			if (itemStack.getType().equals(Material.REDSTONE_BLOCK)) {
				// player.sendMessage("§cCe hub est indisponible.");
				player.sendTranslatedMessage("hub.changer.unavailable");
				return;
			}
			ItemMeta itemMeta = itemStack.getItemMeta();
			if (itemMeta == null)
				return;
			if (itemStack.getType().equals(Material.WOOL)) {
				for (Hub hub : Hub.getHubs()) {
					if (hub.getItemStack().getItemMeta() != null && hub.getItemStack().getItemMeta().getDisplayName()
							.equals(itemStack.getItemMeta().getDisplayName())) {
						if (hub.getHubName().equals(Bukkit.getServerName())) {
							player.sendTranslatedMessage("hub.changer.alreadyconnected");
							// player.sendMessage("§cVous êtes déjà connecté sur
							// ce hub.");
							return;
						}
						if (!hub.isOnline()) {
							// player.sendMessage("§cCe hub est indisponible.");
							player.sendTranslatedMessage("hub.changer.unavailable");
							return;
						}
						if (hub.getPlayers() >= hub.getSlots()) {
							// player.sendMessage("§cCe hub est complet.");
							player.sendTranslatedMessage("hub.changer.full");
							return;
						}
						player.sendTranslatedMessage("hub.changer.teleporting", hub.getId());
						// player.sendMessage("§7Téléportation au hub n°§b" +
						// hub.getId() + "§7...");
						ByteArrayDataOutput out = ByteStreams.newDataOutput();
						out.writeUTF("ConnectOther");
						out.writeUTF(player.getName());
						out.writeUTF(hub.getHubName());
						player.sendPluginMessage(BadBlockHub.getInstance(), "BungeeCord", out.toByteArray());
						return;
					}
				}
				player.sendTranslatedMessage("hub.changer.unknown");
				// player.sendMessage("§cHub inexistant.");
				return;
			}
		}

	}

}
