package fr.xmalware.badblock.hub.listeners;

import java.util.List;
import java.util.Map.Entry;

import org.bukkit.Material;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.block.Action;
import org.bukkit.event.player.PlayerInteractEvent;
import org.bukkit.inventory.ItemStack;

import fr.xmalware.badblock.hub.inventories.ItemAction;
import fr.xmalware.badblock.hub.inventories.abstracts.CustomItem;
import fr.xmalware.badblock.hub.objects.HubPlayer;

public class PlayerInteractListener extends _HubListener {
	
	@EventHandler
	public void onPlayerInteract(PlayerInteractEvent event) {
		Player player = event.getPlayer();
		Action action = event.getAction();
		HubPlayer lobbyPlayer = HubPlayer.get(player);
		event.setCancelled(!lobbyPlayer.isAdmin());
		// Right click on a basic item
		if (player.getItemInHand() == null || player.getItemInHand().getType().equals(Material.AIR)) return;
		ItemStack itemStack = player.getItemInHand();
		ItemAction itemAction = ItemAction.get(action);
		for (Entry<CustomItem, List<ItemStack>> entry : CustomItem.getItems().entrySet()) {
			if (!(entry.getKey() instanceof CustomItem)) continue;
			CustomItem customItem = (CustomItem) entry.getKey();
			if (itemAction == null) continue;
			if (!customItem.getActions().contains(itemAction)) continue;
			boolean ok = false;
			for (ItemStack stack : entry.getValue()) {
				if (stack.isSimilar(itemStack)) {
					ok = true;
					break;
				}
			}
			if (!ok) continue;
			if (lobbyPlayer.hasSpam()) return;
			if (customItem.getNeededPermission() != null && !lobbyPlayer.hasPermission(customItem.getNeededPermission())) {
				player.sendMessage(customItem.getErrorNeededPermission());
				return;
			}
			customItem.onClick(lobbyPlayer, itemAction, event.getClickedBlock());
		}
	}
	
}
