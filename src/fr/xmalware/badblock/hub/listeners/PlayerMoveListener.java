package fr.xmalware.badblock.hub.listeners;

import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.Sound;
import org.bukkit.block.Block;
import org.bukkit.event.EventHandler;
import org.bukkit.event.player.PlayerMoveEvent;
import org.bukkit.util.Vector;

import fr.badblock.gameapi.players.BadblockPlayer;
import fr.badblock.gameapi.utils.ConfigUtils;
import fr.xmalware.badblock.hub.BadBlockHub;
import fr.xmalware.badblock.hub.objects.HubPlayer;

public class PlayerMoveListener extends _HubListener {

	@SuppressWarnings("deprecation")
	@EventHandler
	public void onPlayerMove(PlayerMoveEvent event) {
		BadblockPlayer player = (BadblockPlayer) event.getPlayer();
		Location to = event.getTo();
		Location underOne = to.clone().add(0, -1, 0);
		Location underTwo = to.clone().add(0, -2, 0);
		Block blockOne = underOne.getBlock();
		Block blockTwo = underTwo.getBlock();
		BadBlockHub hub = BadBlockHub.getInstance();
		if ((blockOne.getType().equals(Material.WOOL) && blockOne.getData() == 10)
				|| (blockTwo.getType().equals(Material.WOOL) && blockTwo.getData() == 10)) {
			HubPlayer hubPlayer = HubPlayer.get(player);
			if (hubPlayer.mountEntity != null && hubPlayer.mountEntity.isValid()) {
				hubPlayer.mountEntity.setVelocity(player.getLocation().getDirection().multiply(9));
				hubPlayer.mountEntity
						.setVelocity(new Vector(player.getVelocity().getX(), 3.0D, player.getVelocity().getZ()));
			}
			player.playSound(player.getLocation(), Sound.FIREWORK_LAUNCH, 100F, 1F);
			player.setVelocity(player.getLocation().getDirection().multiply(9));
			player.setVelocity(new Vector(player.getVelocity().getX(), 3.0D, player.getVelocity().getZ()));
		}

		if (hub.getCuboid() != null && !hub.getCuboid().isInSelection(to)
				&& !player.hasAdminMode()) {
			Location playerCenterLocation = ConfigUtils.getLocation(hub, "worldspawn");
			double x = playerCenterLocation.getX() - to.getX();
			double y = playerCenterLocation.getY() - to.getY();
			double z = playerCenterLocation.getZ() - to.getZ();
			Vector throwVector = new Vector(x, y, z);
			throwVector.normalize();
			throwVector.multiply(2);
			player.setVelocity(throwVector);
			player.playSound(player.getLocation(), Sound.ANVIL_BREAK, 100F, 2F);
		}
		

		if (hub.getVipCuboid() != null && hub.getVipCuboid().isInSelection(to) && !player.hasAdminMode() && !player.hasPermission("hub.vipzone")) {
			Location playerCenterLocation = ConfigUtils.getLocation(hub, "worldspawn");
			double x = playerCenterLocation.getX() - to.getX();
			double y = playerCenterLocation.getY() - to.getY();
			double z = playerCenterLocation.getZ() - to.getZ();
			Vector throwVector = new Vector(x, y, z);
			throwVector.normalize();
			throwVector.multiply(2);
			player.setVelocity(throwVector);
			player.playSound(player.getLocation(), Sound.ANVIL_BREAK, 100F, 2F);
			hub.getLelannNPC().show(player, hub.getLelannTurnbackLocation());
			hub.getXmalwareNPC().show(player, hub.getXmalwareTurnbackLocation());
			hub.getVipCuboid().getBlocks().parallelStream().forEach(block -> player.sendBlockChange(block.getLocation(), Material.STAINED_GLASS_PANE, (byte) 14)); 
			HubPlayer.get(player).setLastVipCuboid(System.currentTimeMillis() + 2500);
		}
		
		if (to.getY() <= 0)
			event.setTo(ConfigUtils.getLocation(hub, "worldspawn"));
	}

}
