package fr.xmalware.badblock.hub.listeners;

import org.bukkit.Bukkit;
import org.bukkit.GameMode;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.player.PlayerJoinEvent;

import fr.badblock.gameapi.GameAPI;
import fr.badblock.gameapi.packets.watchers.WatcherVillager;
import fr.xmalware.badblock.hub.BadBlockHub;
import fr.xmalware.badblock.hub.inventories.join.PlayerCustomInventory;
import fr.xmalware.badblock.hub.objects.HubPlayer;
import fr.xmalware.badblock.hub.utils.ConfigUtils;

public class PlayerJoinListener extends _HubListener {
	
	@EventHandler
	public void onPlayerJoin(PlayerJoinEvent event) {
		Player player = event.getPlayer();
		HubPlayer lobbyPlayer = HubPlayer.get(player);
		BadBlockHub.getInstance().hubPacketThread.sendPacket();
		// Load
		load(lobbyPlayer, event);
	}
	
	public static void load(HubPlayer lobbyPlayer, PlayerJoinEvent event) {
		if (event != null)
			event.setJoinMessage(null);
		
		Player player = lobbyPlayer.getPlayer();
		// Teleportation
		player.getInventory().clear();
		player.setMaxHealth(2D);
		player.setHealth(2D);
		player.setWalkSpeed(0.4F);
		player.teleport(ConfigUtils.getLocation(BadBlockHub.getInstance(), "worldspawn"));
		GameAPI.getAPI().spawnFakeLivingEntity(player.getLocation(), EntityType.VILLAGER, WatcherVillager.class).getWatchers().setBaby(true);
		player.setGameMode(GameMode.ADVENTURE);
		
		lobbyPlayer.update();
			
		// Broadcast a join message
		if (lobbyPlayer.hasPermission("hub.broadcastjoin")) {
			if (event != null)
				event.setJoinMessage(lobbyPlayer.getPrefix() + lobbyPlayer.getName() + " ยง7a rejoint ce hub!");
		}
		
		// Objects give
		PlayerCustomInventory.give(player);
		
	}
	
}
