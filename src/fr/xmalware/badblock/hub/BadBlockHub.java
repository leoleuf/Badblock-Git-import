package fr.xmalware.badblock.hub;

import java.io.File;
import java.util.ArrayList;
import java.util.List;

import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.World;
import org.bukkit.entity.Animals;
import org.bukkit.entity.Creature;
import org.bukkit.entity.Entity;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;

import com.google.gson.Gson;

import fr.badblock.gameapi.BadblockPlugin;
import fr.badblock.gameapi.GameAPI;
import fr.badblock.gameapi.fakeentities.FakeEntity;
import fr.badblock.gameapi.packets.watchers.WatcherBlaze;
import fr.badblock.gameapi.packets.watchers.WatcherCreeper;
import fr.badblock.gameapi.packets.watchers.WatcherEnderman;
import fr.badblock.gameapi.packets.watchers.WatcherSkeleton;
import fr.badblock.gameapi.packets.watchers.WatcherVillager;
import fr.badblock.gameapi.packets.watchers.WatcherWitch;
import fr.badblock.gameapi.packets.watchers.WatcherZombie;
import fr.badblock.gameapi.players.BadblockPlayer;
import fr.badblock.gameapi.utils.i18n.TranslatableString;
import fr.badblock.gameapi.utils.selections.CuboidSelection;
import fr.xmalware.badblock.hub.commands.AdminCommand;
import fr.xmalware.badblock.hub.commands.SpawnCommand;
import fr.xmalware.badblock.hub.effectlib.EffectManager;
import fr.xmalware.badblock.hub.inventories.hubchanger.HubChangerInventory;
import fr.xmalware.badblock.hub.inventories.join.PlayerCustomInventory;
import fr.xmalware.badblock.hub.listeners.AsyncPlayerChatListener;
import fr.xmalware.badblock.hub.listeners.CreatureSpawnListener;
import fr.xmalware.badblock.hub.listeners.EntityCombustListener;
import fr.xmalware.badblock.hub.listeners.HubMapProtector;
import fr.xmalware.badblock.hub.listeners.InventoryClickListener;
import fr.xmalware.badblock.hub.listeners.PlayerFakeEntityInteractListener;
import fr.xmalware.badblock.hub.listeners.PlayerInteractListener;
import fr.xmalware.badblock.hub.listeners.PlayerJoinListener;
import fr.xmalware.badblock.hub.listeners.PlayerMoveListener;
import fr.xmalware.badblock.hub.listeners.PlayerQuitListener;
import fr.xmalware.badblock.hub.rabbit.HubPacketListener;
import fr.xmalware.badblock.hub.rabbit.HubPacketThread;
import fr.xmalware.badblock.hub.rabbit.SEntryInfosListener;
import fr.xmalware.badblock.hub.riders.MountManager;
import fr.xmalware.badblock.hub.tasks.ChestParticlesTask;
import fr.xmalware.badblock.hub.utils.ConfigUtils;
import fr.xmalware.badblock.rabbitconnector.RabbitConnector;
import fr.xmalware.badblock.rabbitconnector.RabbitService;
import lombok.Getter;
import lombok.Setter;

@Getter @Setter public class BadBlockHub extends BadblockPlugin {

	@Getter @Setter private static BadBlockHub			instance;
	public CuboidSelection								cuboid;
	public EffectManager								effectManager;
	public List<FakeEntity<?>>							fakeEntities;
	public Gson											gson 				= GameAPI.getGson();
	public HubPacketThread								hubPacketThread;
	public RabbitConnector								rabbitConnector;
	public RabbitService								rabbitService;

	@Override
	public void onDisable() {
		this.getRabbitService().remove();
	}

	@Override
	public void onEnable() {
		setInstance(this);
		new MountManager();
        effectManager = new EffectManager(this);
        new ChestParticlesTask();
		this.reloadConfig();
		getServer().getMessenger().registerOutgoingPluginChannel(this, "BungeeCord");
		PlayerCustomInventory.load();
		this.setFakeEntities(new ArrayList<>());
		Location location = new Location(Bukkit.getWorld("world"), -77.121, 75.06250, -0.599);
		location.setYaw(-58.7F);
		location.setPitch(1.2F);
		FakeEntity<WatcherWitch> fakeEntity = GameAPI.getAPI().spawnFakeLivingEntity(location, EntityType.WITCH, WatcherWitch.class);
		fakeEntity.getWatchers().setCustomName(new TranslatableString("hub.witchname"));
		fakeEntity.getWatchers().setCustomNameVisible(true);
		this.getFakeEntities().add(fakeEntity);
		this.setRabbitConnector(RabbitConnector.getInstance());
		this.setRabbitService(this.getRabbitConnector().getService("default"));
		this.setHubPacketThread(new HubPacketThread(this.getRabbitService()));
		HubChangerInventory.get(HubChangerInventory.class);
		new HubPacketListener();
		new SEntryInfosListener();// EntityType type, boolean movable, boolean rideable, boolean canFly, boolean inversed, String customName) {
		MountManager.spawn(ConfigUtils.getLocation(this, "gamepnj.tower"), EntityType.ZOMBIE, WatcherZombie.class, false, false, false, false, new TranslatableString("hub.gamepnj.tower"));
		MountManager.spawn(ConfigUtils.getLocation(this, "gamepnj.rush"), EntityType.VILLAGER, WatcherVillager.class, false, false, false, false, new TranslatableString("hub.gamepnj.rush"));
		MountManager.spawn(ConfigUtils.getLocation(this, "gamepnj.pearlswar"), EntityType.ENDERMAN, WatcherEnderman.class, false, false, false, false, new TranslatableString("hub.gamepnj.pearlswar"));
		MountManager.spawn(ConfigUtils.getLocation(this, "gamepnj.spaceballs"), EntityType.CREEPER, WatcherCreeper.class, false, false, false, false, new TranslatableString("hub.gamepnj.spaceballs"));
		MountManager.spawn(ConfigUtils.getLocation(this, "gamepnj.speeduhc"), EntityType.BLAZE, WatcherBlaze.class, false, false, false, false, new TranslatableString("hub.gamepnj.speeduhc"));
		MountManager.spawn(ConfigUtils.getLocation(this, "gamepnj.survivalgames"), EntityType.SKELETON, WatcherSkeleton.class, false, false, false, false, new TranslatableString("hub.gamepnj.survivalgames"));
		Location loc1 = ConfigUtils.getLocation(this, "limit.loc1");
		Location loc2 = ConfigUtils.getLocation(this, "limit.loc2");

		if(loc1 != null && loc2 != null) {
			loc1.setY(0);
			loc2.setY(256);
			this.setCuboid(new CuboidSelection(loc1, loc2));
		}

		new AdminCommand();
		new SpawnCommand();

		this.reloadConfig();

		for(World w : Bukkit.getWorlds()) {
			for(Entity entity : w.getEntitiesByClasses(Animals.class, Creature.class))
				entity.remove();

			w.setFullTime(0);
			w.setPVP(false);
			w.setStorm(false);
			w.setThunderDuration(0);
			w.setThundering(false);
			w.setWeatherDuration(0);
			w.setTime(0);
		}

		getAPI().formatChat(true, false, "hub");
		getAPI().getBadblockScoreboard().doGroupsPrefix();
		getAPI().setMapProtector(new HubMapProtector());
		getAPI().managePortals(new File(getDataFolder(), "portals"));

		// Registering all events
		new AsyncPlayerChatListener();
		new CreatureSpawnListener();
		new EntityCombustListener();
		new InventoryClickListener();
		new PlayerInteractListener();
		new PlayerJoinListener();
		new PlayerMoveListener();
		new PlayerQuitListener();
		new PlayerFakeEntityInteractListener();	

		// Reload players
		for (Player player : Bukkit.getOnlinePlayers()) PlayerJoinListener.load((BadblockPlayer) player, null);
	}

}
