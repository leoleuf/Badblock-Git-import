package fr.xmalware.badblock.hub;

import java.io.File;

import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.entity.Animals;
import org.bukkit.entity.Creature;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import fr.badblock.gameapi.BadblockPlugin;
import fr.badblock.gameapi.GameAPI;
import fr.badblock.gameapi.players.BadblockPlayer;
import fr.badblock.gameapi.run.RunType;
import fr.badblock.gameapi.utils.ConfigUtils;
import fr.badblock.gameapi.utils.selections.CuboidSelection;
import fr.badblock.rabbitconnector.RabbitConnector;
import fr.badblock.rabbitconnector.RabbitService;
import fr.xmalware.badblock.hub.commands.AdminCommand;
import fr.xmalware.badblock.hub.commands.LocCommand;
import fr.xmalware.badblock.hub.commands.NPCCommand;
import fr.xmalware.badblock.hub.commands.RaceCommand;
import fr.xmalware.badblock.hub.commands.SpawnCommand;
import fr.xmalware.badblock.hub.effectlib.EffectManager;
import fr.xmalware.badblock.hub.inventories.LinkedInventoryEntity;
import fr.xmalware.badblock.hub.inventories.abstracts.inventories.CustomInventory;
import fr.xmalware.badblock.hub.inventories.hubchanger.HubChangerInventory;
import fr.xmalware.badblock.hub.inventories.join.PlayerCustomInventory;
import fr.xmalware.badblock.hub.listeners.AsyncPlayerChatListener;
import fr.xmalware.badblock.hub.listeners.CreatureSpawnListener;
import fr.xmalware.badblock.hub.listeners.EntityCombustListener;
import fr.xmalware.badblock.hub.listeners.HubMapProtector;
import fr.xmalware.badblock.hub.listeners.InventoryClickListener;
import fr.xmalware.badblock.hub.listeners.PlayerFakeEntityInteractListener;
import fr.xmalware.badblock.hub.listeners.PlayerInteractListener;
import fr.xmalware.badblock.hub.listeners.PlayerJoinListener;
import fr.xmalware.badblock.hub.listeners.PlayerMoveListener;
import fr.xmalware.badblock.hub.listeners.PlayerQuitListener;
import fr.xmalware.badblock.hub.listeners.vipzone.RaceListener;
import fr.xmalware.badblock.hub.rabbit.HubPacketListener;
import fr.xmalware.badblock.hub.rabbit.HubPacketThread;
import fr.xmalware.badblock.hub.rabbit.SEntryInfosListener;
import fr.xmalware.badblock.hub.riders.MountManager;
import fr.xmalware.badblock.hub.tasks.RequestNPCTask;
import lombok.Getter;
import lombok.Setter;

@Getter
@Setter
public class BadBlockHub extends BadblockPlugin {

	@Getter
	@Setter
	private static BadBlockHub instance;
	public CuboidSelection cuboid;
	public CuboidSelection vipPushCuboid;
	public CuboidSelection vipPortalCuboid;
	public EffectManager effectManager;
	public Gson gson = GameAPI.getGson();
	public Gson gsonExpose = new GsonBuilder().setPrettyPrinting().excludeFieldsWithoutExposeAnnotation().create();
	public HubPacketThread hubPacketThread;
	public RabbitConnector rabbitConnector;
	public RabbitService rabbitService;

	/*
	 * public NPC lelannNPC; public Location lelannLocation; public NPC
	 * xmalwareNPC; public Location xmalwareLocation; public Location
	 * lelannTurnbackLocation; public Location xmalwareTurnbackLocation;
	 */

	@Override
	public void onDisable() {
		this.getRabbitService().remove();
	}

	@Override
	public void onEnable(RunType runType) {
		// Singleton
		setInstance(this);
		// Configuration
		this.reloadConfig();
		// Mounts
		new MountManager();
		// Effects
		effectManager = new EffectManager(this);
		// Tasks
		new RequestNPCTask();
		// Player items
		PlayerCustomInventory.load();
		// xMalware NPC
		/*
		 * if (!this.getConfig().contains("npc.xmalware.normal"))
		 * ConfigUtils.saveLocation(this, "npc.xmalware.normal",
		 * Bukkit.getWorld("world").getSpawnLocation()); Location location =
		 * ConfigUtils.getLocation(this, "npc.xmalware.normal");
		 * xmalwareLocation = location; xmalwareNPC = new NPC("xMalware",
		 * UUID.fromString("89a1ccaf-baf0-4b4c-9cc0-d4e40f9b02aa")); // LeLanN
		 * NPC if (!this.getConfig().contains("npc.lelann.normal"))
		 * ConfigUtils.saveLocation(this, "npc.lelann.normal",
		 * Bukkit.getWorld("world").getSpawnLocation()); location =
		 * ConfigUtils.getLocation(this, "npc.lelann.normal"); lelannLocation =
		 * location; lelannNPC = new NPC("LeLanN",
		 * UUID.fromString("443fbe17-448c-4acd-bbed-2673652f18fc")); if
		 * (!this.getConfig().contains("npc.lelann.turnback"))
		 * ConfigUtils.saveLocation(this, "npc.lelann.turnback",
		 * Bukkit.getWorld("world").getSpawnLocation()); if
		 * (!this.getConfig().contains("npc.xmalware.turnback"))
		 * ConfigUtils.saveLocation(this, "npc.xmalware.turnback",
		 * Bukkit.getWorld("world").getSpawnLocation()); // Turnback
		 * lelannTurnbackLocation = ConfigUtils.getLocation(this,
		 * "npc.lelann.turnback"); xmalwareTurnbackLocation =
		 * ConfigUtils.getLocation(this, "npc.xmalware.turnback");
		 */
		// Rabbit
		this.setRabbitConnector(RabbitConnector.getInstance());
		this.setRabbitService(this.getRabbitConnector().getService("default"));
		this.setHubPacketThread(new HubPacketThread(this.getRabbitService()));
		// Hub changer
		CustomInventory.get(HubChangerInventory.class);
		new HubPacketListener();
		// SEntry
		new SEntryInfosListener();
		// Inventories interactions by fake-entities
		LinkedInventoryEntity.load();
		// Limit
		Location loc1 = ConfigUtils.getLocation(this, "limit.loc1");
		Location loc2 = ConfigUtils.getLocation(this, "limit.loc2");
		if (loc1 != null && loc2 != null) {
			loc1.setY(0);
			loc2.setY(256);
			this.setCuboid(new CuboidSelection(loc1, loc2));
		}
		// VIP Portal
		Location defaultLocation = new Location(Bukkit.getWorld("world"), 0, 0, 0);
		loc1 = ConfigUtils.getBlockLocationFromFile(this, "viplimit.portal.loc1");
		if (loc1 == null) {
			ConfigUtils.saveLocation(this, "viplimit.portal.loc1", defaultLocation);
			loc1 = defaultLocation;
		}
		loc2 = ConfigUtils.getBlockLocationFromFile(this, "viplimit.portal.loc2");
		if (loc2 == null) {
			ConfigUtils.saveLocation(this, "viplimit.portal.loc2", defaultLocation);
			loc2 = defaultLocation;
		}
		this.setVipPortalCuboid(new CuboidSelection(loc1, loc2));
		// VIP Push
		loc1 = ConfigUtils.getBlockLocationFromFile(this, "viplimit.push.loc1");
		if (loc1 == null) {
			ConfigUtils.saveLocation(this, "viplimit.push.loc1", defaultLocation);
			loc1 = defaultLocation;
		}
		loc2 = ConfigUtils.getBlockLocationFromFile(this, "viplimit.push.loc2");
		if (loc2 == null) {
			ConfigUtils.saveLocation(this, "viplimit.push.loc2", defaultLocation);
			loc2 = defaultLocation;
		}
		this.setVipPushCuboid(new CuboidSelection(loc1, loc2));
		// Commands
		new NPCCommand();
		new AdminCommand();
		new SpawnCommand();
		new LocCommand();
		new RaceCommand();
		// Reload configuration
		this.reloadConfig();
		// World manage
		Bukkit.getWorlds().forEach(world -> {
			world.getEntitiesByClasses(Animals.class, Creature.class).forEach(entity -> entity.remove());
			world.setFullTime(0);
			world.setPVP(false);
			world.setStorm(false);
			world.setThunderDuration(0);
			world.setThundering(false);
			world.setWeatherDuration(0);
			world.setTime(0);
		});

		// API compatibility
		getAPI().formatChat(true, false, "hub");
		getAPI().getBadblockScoreboard().doGroupsPrefix();
		getAPI().setMapProtector(new HubMapProtector());
		getAPI().managePortals(new File(getDataFolder(), "portals"));

		// Registering all events
		new AsyncPlayerChatListener();
		new CreatureSpawnListener();
		new EntityCombustListener();
		new InventoryClickListener();
		new PlayerInteractListener();
		new PlayerJoinListener();
		new PlayerMoveListener();
		new PlayerQuitListener();
		new PlayerFakeEntityInteractListener();
		new RaceListener(this);

		// Reload players
		Bukkit.getOnlinePlayers().forEach(player -> PlayerJoinListener.load((BadblockPlayer) player, null));
	}

}
