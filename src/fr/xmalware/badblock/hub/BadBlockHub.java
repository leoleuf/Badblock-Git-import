package fr.xmalware.badblock.hub;

import java.io.File;
import java.util.ArrayList;
import java.util.List;

import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.World;
import org.bukkit.entity.Animals;
import org.bukkit.entity.Creature;
import org.bukkit.entity.Entity;
import org.bukkit.entity.EntityType;
import org.bukkit.entity.Player;

import com.google.gson.Gson;

import fr.badblock.gameapi.BadblockPlugin;
import fr.badblock.gameapi.GameAPI;
import fr.badblock.gameapi.fakeentities.FakeEntity;
import fr.badblock.gameapi.packets.watchers.WatcherSkeleton;
import fr.badblock.gameapi.players.BadblockPlayer;
import fr.badblock.gameapi.utils.selections.CuboidSelection;
import fr.xmalware.badblock.hub.commands.AdminCommand;
import fr.xmalware.badblock.hub.commands.MTPCommand;
import fr.xmalware.badblock.hub.commands.SpawnCommand;
import fr.xmalware.badblock.hub.inventories.hubchanger.HubChangerInventory;
import fr.xmalware.badblock.hub.listeners.CreatureSpawnListener;
import fr.xmalware.badblock.hub.listeners.EntityCombustListener;
import fr.xmalware.badblock.hub.listeners.HubMapProtector;
import fr.xmalware.badblock.hub.listeners.InventoryClickListener;
import fr.xmalware.badblock.hub.listeners.PlayerFakeEntityInteractListener;
import fr.xmalware.badblock.hub.listeners.PlayerInteractListener;
import fr.xmalware.badblock.hub.listeners.PlayerJoinListener;
import fr.xmalware.badblock.hub.listeners.PlayerMoveListener;
import fr.xmalware.badblock.hub.listeners.PlayerQuitListener;
import fr.xmalware.badblock.hub.rabbit.HubPacketListener;
import fr.xmalware.badblock.hub.rabbit.HubPacketThread;
import fr.xmalware.badblock.hub.rabbit.SEntryInfosListener;
import fr.xmalware.badblock.hub.riders.MountManager;
import fr.xmalware.badblock.hub.utils.ConfigUtils;
import fr.xmalware.badblock.rabbitconnector.RabbitConnector;
import fr.xmalware.badblock.rabbitconnector.RabbitService;
import lombok.Getter;
import lombok.Setter;

@Getter @Setter public class BadBlockHub extends BadblockPlugin {

	@Getter @Setter private static BadBlockHub			instance;
	public CuboidSelection								cuboid;
	public RabbitConnector								rabbitConnector;
	public RabbitService								rabbitService;
	public Gson											gson 				= GameAPI.getGson();
	public HubPacketThread								hubPacketThread;
	public List<FakeEntity<?>>							fakeEntities;
	
	@Override
	public void onEnable() {
		setInstance(this);
		new MountManager();
		getServer().getMessenger().registerOutgoingPluginChannel(this, "BungeeCord");

		this.setFakeEntities(new ArrayList<>());
		
		FakeEntity<WatcherSkeleton> fakeEntity = GameAPI.getAPI().spawnFakeLivingEntity(new Location(Bukkit.getWorld("world"), 0, 80, -92), EntityType.SKELETON, WatcherSkeleton.class);
		fakeEntity.getWatchers().setCustomName("Â§aTower de CUL");
		fakeEntity.getWatchers().setArrowsInEntity(32);
		
		this.getFakeEntities().add(fakeEntity);
		this.setRabbitConnector(RabbitConnector.getInstance());
		this.setRabbitService(this.getRabbitConnector().getService("default"));
		this.setHubPacketThread(new HubPacketThread(this.getRabbitService()));
		HubChangerInventory.get(HubChangerInventory.class);
		new HubPacketListener();
		new SEntryInfosListener();
		
		Location loc1 = ConfigUtils.getLocation(this, "limit.loc1");
		Location loc2 = ConfigUtils.getLocation(this, "limit.loc2");
		
		if(loc1 != null && loc2 != null) {
			loc1.setY(0);
			loc2.setY(256);
			this.setCuboid(new CuboidSelection(loc1, loc2));
		}
		
		new AdminCommand();
		new SpawnCommand();
		new MTPCommand();
		
		this.reloadConfig();
		
		for(World w : Bukkit.getWorlds()) {
			for(Entity entity : w.getEntitiesByClasses(Animals.class, Creature.class))
				entity.remove();
			
			w.setFullTime(0);
			w.setPVP(false);
			w.setStorm(false);
			w.setThunderDuration(0);
			w.setThundering(false);
			w.setWeatherDuration(0);
			w.setTime(0);
		}

		getAPI().formatChat(true, false, "hub");
		getAPI().getBadblockScoreboard().doGroupsPrefix();
		getAPI().setMapProtector(new HubMapProtector());
		getAPI().managePortals(new File(getDataFolder(), "portals"));
		
		// Registering all events
		new CreatureSpawnListener();
		new EntityCombustListener();
		new InventoryClickListener();
		new PlayerInteractListener();
		new PlayerJoinListener();
		new PlayerMoveListener();
		new PlayerQuitListener();
		new PlayerFakeEntityInteractListener();
		
		// Reload players
		for (Player player : Bukkit.getOnlinePlayers()) PlayerJoinListener.load((BadblockPlayer) player, null);
	}

	@Override
	public void onDisable() {
		this.getRabbitService().remove();
	}

}
