package fr.xmalware.badblock.hub.npc;

import java.util.HashMap;
import java.util.UUID;

import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.craftbukkit.v1_8_R3.CraftServer;
import org.bukkit.craftbukkit.v1_8_R3.CraftWorld;
import org.bukkit.craftbukkit.v1_8_R3.entity.CraftPlayer;
import org.bukkit.entity.Player;

import com.mojang.authlib.GameProfile;

import net.minecraft.server.v1_8_R3.EntityPlayer;
import net.minecraft.server.v1_8_R3.MinecraftServer;
import net.minecraft.server.v1_8_R3.PacketPlayOutEntityDestroy;
import net.minecraft.server.v1_8_R3.PacketPlayOutNamedEntitySpawn;
import net.minecraft.server.v1_8_R3.PacketPlayOutPlayerInfo;
import net.minecraft.server.v1_8_R3.PacketPlayOutPlayerInfo.EnumPlayerInfoAction;
import net.minecraft.server.v1_8_R3.PlayerConnection;
import net.minecraft.server.v1_8_R3.PlayerInteractManager;
import net.minecraft.server.v1_8_R3.WorldServer;

public class NPC
{

	int entityid;
	Player p;
	String name;
	UUID uuid;
	public EntityPlayer npc;
	Location loc;
	public static HashMap<Integer, NPC> npcs = new HashMap<>();

	public NPC(Player p, Location loc)
	{
		this.p = p;
		this.loc = loc;
	}

	public void spawn(Player p, String npc, UUID uuid)
	{
		MinecraftServer nmsServer = ((CraftServer)Bukkit.getServer()).getServer();
		WorldServer nmsWorld = ((CraftWorld)Bukkit.getWorlds().get(0)).getHandle();
		this.name = npc;
		this.uuid = uuid;
		
		double rx = loc.getX();
		double ry = loc.getY();
		double rz = loc.getZ();
		
		/*Random r = new Random();
		double rx = loc.getX() + r.nextInt(2) + 1;
		
		Random r1 = new Random();
		double ry = loc.getY() + r1.nextInt(2) + 1;
		
		Random r2 = new Random();
		double rz = loc.getZ() + r2.nextInt(2);*/
		
		this.npc = new EntityPlayer(nmsServer, nmsWorld, new GameProfile(UUID.randomUUID(), this.name), new PlayerInteractManager(nmsWorld));
		//this.npc.setLocation(this.loc.getX(), this.loc.getY(), this.loc.getZ(), 0.0F, 0.0F);
		this.loc = new Location(loc.getWorld(), rx, ry, rz, 0.0F, 0.0F);
		this.npc.setLocation(rx, ry, rz, 0.0F, 0.0F);
		this.npc.spawnIn(nmsWorld);
		
		//this.npc.setSneaking(true);

		this.entityid = this.npc.getId();
		PlayerConnection connection = ((CraftPlayer)this.p).getHandle().playerConnection; 
		connection.sendPacket(new PacketPlayOutPlayerInfo(PacketPlayOutPlayerInfo.EnumPlayerInfoAction.ADD_PLAYER, new EntityPlayer[] { this.npc }));
		connection.sendPacket(new PacketPlayOutNamedEntitySpawn(this.npc));
		npcs.put(this.npc.getId(), this);
	}

	public void despawn()
	{
		npcs.remove(this.npc.getId());
		final PlayerConnection connection = ((CraftPlayer) p).getHandle().playerConnection;
		connection.sendPacket(new PacketPlayOutPlayerInfo(EnumPlayerInfoAction.REMOVE_PLAYER, npc));
		connection.sendPacket(new PacketPlayOutEntityDestroy(npc.getId()));
		npc.die();
	}

	public Integer getEntityId()
	{
		return Integer.valueOf(this.entityid);
	}

	public Location getLocation() {
		return loc;
	}
	
	
	
}
