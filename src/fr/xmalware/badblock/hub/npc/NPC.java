package fr.xmalware.badblock.hub.npc;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;

import org.bukkit.Bukkit;
import org.bukkit.Location;
import org.bukkit.craftbukkit.v1_8_R3.CraftServer;
import org.bukkit.craftbukkit.v1_8_R3.CraftWorld;
import org.bukkit.craftbukkit.v1_8_R3.entity.CraftPlayer;

import com.mojang.authlib.GameProfile;

import fr.badblock.gameapi.players.BadblockPlayer;
import net.minecraft.server.v1_8_R3.EntityPlayer;
import net.minecraft.server.v1_8_R3.MinecraftServer;
import net.minecraft.server.v1_8_R3.PacketPlayOutEntityDestroy;
import net.minecraft.server.v1_8_R3.PacketPlayOutNamedEntitySpawn;
import net.minecraft.server.v1_8_R3.PacketPlayOutPlayerInfo;
import net.minecraft.server.v1_8_R3.PacketPlayOutPlayerInfo.EnumPlayerInfoAction;
import net.minecraft.server.v1_8_R3.PlayerConnection;
import net.minecraft.server.v1_8_R3.PlayerInteractManager;
import net.minecraft.server.v1_8_R3.WorldServer;

public class NPC
{

	int entityid;
	public EntityPlayer npc;
	Location loc;
	List<BadblockPlayer> players;
	private UUID uuid;
	private String name;
	public static HashMap<Integer, NPC> npcs = new HashMap<>();

	public NPC(Location loc, String name, UUID uuid)
	{
		this.loc = loc;
		this.name = name;
		this.uuid = uuid;
		this.players = new ArrayList<>();
	}

	public NPC spawn()
	{
		MinecraftServer nmsServer = ((CraftServer)Bukkit.getServer()).getServer();
		WorldServer nmsWorld = ((CraftWorld)Bukkit.getWorlds().get(0)).getHandle();

		double rx = loc.getX();
		double ry = loc.getY();
		double rz = loc.getZ();

		/*Random r = new Random();
		double rx = loc.getX() + r.nextInt(2) + 1;

		Random r1 = new Random();
		double ry = loc.getY() + r1.nextInt(2) + 1;

		Random r2 = new Random();
		double rz = loc.getZ() + r2.nextInt(2);*/

		this.npc = new EntityPlayer(nmsServer, nmsWorld, new GameProfile(uuid, name), new PlayerInteractManager(nmsWorld));
		//this.npc.setLocation(this.loc.getX(), this.loc.getY(), this.loc.getZ(), 0.0F, 0.0F);
		this.loc = new Location(loc.getWorld(), rx, ry, rz, 0.0F, 0.0F);
		this.npc.setLocation(rx, ry, rz, loc.getPitch(), loc.getYaw());
		this.npc.spawnIn(nmsWorld);

		//this.npc.setSneaking(true);

		this.entityid = this.npc.getId();
		npcs.put(this.npc.getId(), this);
		return this;
	}

	public void despawn()
	{
		npcs.remove(this.npc.getId());
		players.stream().filter(player -> player.isOnline()).forEach(player -> {
			final PlayerConnection connection = ((CraftPlayer) player).getHandle().playerConnection;
			connection.sendPacket(new PacketPlayOutPlayerInfo(EnumPlayerInfoAction.REMOVE_PLAYER, npc));
			connection.sendPacket(new PacketPlayOutEntityDestroy(npc.getId()));
		});
		npc.die();
	}

	public void show(BadblockPlayer player) {
		PlayerConnection connection = ((CraftPlayer)player).getHandle().playerConnection; 
		connection.sendPacket(new PacketPlayOutPlayerInfo(PacketPlayOutPlayerInfo.EnumPlayerInfoAction.ADD_PLAYER, new EntityPlayer[] { this.npc }));
		connection.sendPacket(new PacketPlayOutNamedEntitySpawn(this.npc));
		players.add(player);
	}

	public Integer getEntityId()
	{
		return Integer.valueOf(this.entityid);
	}

	public Location getLocation() {
		return loc;
	}



}
