package fr.xmalware.badblock.hub.rabbit;

import java.util.HashMap;
import java.util.Map;

import org.bukkit.Bukkit;
import org.bukkit.entity.Player;

import fr.badblock.gameapi.players.BadblockPlayer;
import fr.xmalware.badblock.hub.BadBlockHub;
import fr.xmalware.badblock.rabbitconnector.Encodage;
import fr.xmalware.badblock.rabbitconnector.RabbitPacketType;
import fr.xmalware.badblock.rabbitconnector.RabbitService;

public class HubPacketThread implements Runnable {

	private 		RabbitService		rabbitService;
	public static	boolean				opened			= true;

	public HubPacketThread(RabbitService rabbitService) {
		this.rabbitService = rabbitService;
		Bukkit.getScheduler().runTaskTimer(BadBlockHub.getInstance(), this, 0, 20 * 5L);
	}

	@Override
	public void run() {
		sendPacket();
	}

	public void sendPacket() {
		Map<String, Integer> ranks = new HashMap<>();
		for (Player player : Bukkit.getOnlinePlayers()) {
			BadblockPlayer bPlayer = (BadblockPlayer) player;
			if (!ranks.containsKey(bPlayer.getTabGroupPrefix().getKey())) ranks.put(bPlayer.getTabGroupPrefix().getKey(), 1);
			else ranks.put(bPlayer.getTabGroupPrefix().getKey(), ranks.get(bPlayer.getTabGroupPrefix().getKey()) + 1);
		}
		rabbitService.sendPacket("hub", BadBlockHub.getInstance().getGson().toJson(new HubAliveFactory(Bukkit.getServerName(), Bukkit.getOnlinePlayers().size(), 
				Bukkit.getMaxPlayers(), opened, ranks)), Encodage.UTF8, RabbitPacketType.PUBLISHER, 5000, false);
	}

}
