package fr.xmalware.badblock.hub.rabbit;

import org.bukkit.Bukkit;

import fr.badblock.rabbitconnector.RabbitListener;
import fr.badblock.rabbitconnector.RabbitListenerType;
import fr.xmalware.badblock.hub.BadBlockHub;
import fr.xmalware.badblock.hub.inventories.abstracts.inventories.CustomInventory;
import fr.xmalware.badblock.hub.inventories.hubchanger.HubChangerInventory;

public class HubPacketListener extends RabbitListener {

	public HubPacketListener() {
		super(BadBlockHub.getInstance().getRabbitService(), "hub", false, RabbitListenerType.SUBSCRIBER);
	}

	@Override
	public void onPacketReceiving(String body) {
		if (body == null)
			return;
		HubAliveFactory hubAliveFactory = BadBlockHub.getInstance().getGson().fromJson(body, HubAliveFactory.class);
		if (hubAliveFactory == null)
			return;
		Hub hub = Hub.get(hubAliveFactory.getId());
		if (hub == null) {
			hub = new Hub(hubAliveFactory.getId(), hubAliveFactory.getName());
			hub.create();
		}
		hub.keepAlive(hubAliveFactory.getPlayers(), hubAliveFactory.getSlots(), hubAliveFactory.isOpened(),
				hubAliveFactory.getRanks());
		Bukkit.getScheduler().runTaskLater(BadBlockHub.getInstance(), new Runnable() {
			@Override
			public void run() {
				((HubChangerInventory) CustomInventory.get(HubChangerInventory.class)).update();
			}
		}, 1);
	}

}
