package fr.xmalware.badblock.hub.objects;

import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;

import fr.badblock.gameapi.GameAPI;
import fr.badblock.gameapi.achievements.PlayerAchievement;
import fr.badblock.gameapi.players.BadblockPlayer;
import fr.badblock.gameapi.players.scoreboard.BadblockScoreboardGenerator;
import fr.badblock.gameapi.players.scoreboard.CustomObjective;
import fr.badblock.gameapi.run.BadblockGame;
import fr.xmalware.badblock.hub.BadBlockHub;

public class HubScoreboard extends BadblockScoreboardGenerator {
	private CustomObjective objective;
	private BadblockPlayer  player;

	public HubScoreboard(BadblockPlayer player) {
		this.objective = GameAPI.getAPI().buildCustomObjective("hub");
		this.player = player;
		objective.showObjective(player);
		objective.setDisplayName("&b&o" + i18n("hub_scoreboard.title"));
		objective.setGenerator(this);
		objective.generate();
		
		doBadblockFooter(objective);
	}

	@Override
	public void generate() {
		objective.changeLine(15, "&8&m----------------------");

		int i = 14;

		objective.changeLine(i, "");
		i--;
		objective.changeLine(i, i18n("hub_scoreboard.badcoins", player.getPlayerData().getBadcoins()));
		i--;

		Collection<PlayerAchievement> playerAchievements = new HashSet<>();
		Collection<PlayerAchievement> playerDoneAchievements = new HashSet<>();
		Arrays.asList(BadblockGame.values()).parallelStream().filter(game -> game.getGameData() != null)
				.forEach(game -> playerAchievements.addAll(game.getGameData().getAchievements().getAllAchievements()));
		playerAchievements.parallelStream()
				.filter(playerAchievement -> player.getPlayerData().getAchievementState(playerAchievement).isSucceeds())
				.forEach(playerAchievement -> playerDoneAchievements.add(playerAchievement));
		objective.changeLine(i,
				i18n("hub_scoreboard.achievements", playerDoneAchievements.size(), playerAchievements.size()));
		i--;
		objective.changeLine(i, "");
		i--;
		objective.changeLine(i, i18n("hub_scoreboard.rank", player.getTabGroupPrefix()));
		i--;
		objective.changeLine(i, i18n("hub_scoreboard.server", BadBlockHub.getInstance().getServer().getServerName()));
		i--;
		objective.changeLine(i, "");

		for (int a = 3; a < i; a++)
			objective.removeLine(a);

		objective.changeLine(2, "&8&m----------------------");
	}

	private String i18n(String key, Object... args) {
		return player.getTranslatedMessage(key, args)[0];
	}
}