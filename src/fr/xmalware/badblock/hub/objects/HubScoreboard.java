package fr.xmalware.badblock.hub.objects;

import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;

import org.bukkit.ChatColor;
import org.bukkit.scheduler.BukkitRunnable;

import fr.badblock.gameapi.GameAPI;
import fr.badblock.gameapi.achievements.PlayerAchievement;
import fr.badblock.gameapi.players.BadblockPlayer;
import fr.badblock.gameapi.players.scoreboard.BadblockScoreboardGenerator;
import fr.badblock.gameapi.players.scoreboard.CustomObjective;
import fr.badblock.gameapi.run.BadblockGame;
import fr.xmalware.badblock.hub.BadBlockHub;

public class HubScoreboard extends BukkitRunnable implements BadblockScoreboardGenerator {

	private int current = 0;
	private CustomObjective objective;

	private BadblockPlayer player;

	public HubScoreboard(BadblockPlayer player) {
		this.objective = GameAPI.getAPI().buildCustomObjective("hub");
		this.player = player;
		objective.showObjective(player);
		objective.setDisplayName("&b&o" + i18n("hub.scoreboard.title"));
		objective.setGenerator(this);
		objective.generate();
		runTaskTimer(GameAPI.getAPI(), 0, 3L);
	}

	@Override
	public void generate() {
		objective.changeLine(15, "&8&m----------------------");

		int i = 14;

		/*
		 * for(BadblockTeam team : GameAPI.getAPI().getTeams()){ RushTeamData
		 * data = team.teamData(RushTeamData.class);
		 * 
		 * if(!data.hasBed()) objective.changeLine(i,
		 * team.getChatName().getAsLine(player) + " > &c✘"); else
		 * objective.changeLine(i, team.getChatName().getAsLine(player) +
		 * " > &a✔"); i--; }
		 */

		objective.changeLine(i, "");
		i--;
		objective.changeLine(i, i18n("hub.scoreboard.badcoins", player.getPlayerData().getBadcoins()));
		i--;
		int done = 0;
		Collection<PlayerAchievement> playerAchievements = new HashSet<>();
		Collection<PlayerAchievement> playerDoneAchievements = new HashSet<>();
		Arrays.asList(BadblockGame.values()).parallelStream().filter(game -> game.getGameData() != null)
				.forEach(game -> playerAchievements.addAll(game.getGameData().getAchievements().getAllAchievements()));
		playerAchievements.parallelStream()
				.filter(playerAchievement -> player.getPlayerData().getAchievementState(playerAchievement).isSucceeds())
				.forEach(playerAchievement -> playerDoneAchievements.add(playerAchievement));
		objective.changeLine(i,
				i18n("hub.scoreboard.achievements", playerDoneAchievements.size(), playerAchievements.size()));
		i--;
		objective.changeLine(i, "");
		i--;
		objective.changeLine(i, i18n("hub.scoreboard.rank", player.getTabGroupPrefix()));
		i--;
		objective.changeLine(i, i18n("hub.scoreboard.server", BadBlockHub.getInstance().getServer().getServerName()));
		i--;
		objective.changeLine(i, "");

		for (int a = 3; a < i; a++)
			objective.removeLine(a);

		objective.changeLine(2, "&8&m----------------------");
	}

	private String i18n(String key, Object... args) {
		return player.getTranslatedMessage(key, args)[0];
	}

	@Override
	public void run() {
		String base = "/badblock";
		if (current < 0) {
			objective.changeLine(1, "&b" + base);
		} else {
			String result = "&b" + base.substring(0, current) + ChatColor.BLUE + base.substring(current, current + 1)
					+ "&b" + base.substring(current + 1);
			objective.changeLine(1, result);
		}
		current++;
		if (current == base.length()) {
			current = -10;
		}
	}

}