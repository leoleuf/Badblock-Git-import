package fr.xmalware.badblock.bungee.link.bungee;

import java.util.HashSet;
import java.util.Set;
import java.util.stream.Collectors;

import com.google.gson.Gson;

import fr.toenga.common.tech.rabbitmq.packet.RabbitPacket;
import fr.toenga.common.tech.rabbitmq.packet.RabbitPacketEncoder;
import fr.toenga.common.tech.rabbitmq.packet.RabbitPacketMessage;
import fr.toenga.common.tech.rabbitmq.packet.RabbitPacketType;
import fr.xmalware.badblock.bungee.BadBungee;
import fr.xmalware.badblock.bungee.rabbit.BadBungeeQueues;
import net.md_5.bungee.BungeeCord;

public class BungeeTask extends Thread
{

	public static boolean		run				= true;
	public static BungeeObject	bungeeObject	= new BungeeObject(BadBungee.getInstance().getConfig().getBungeeName(), getIP(), new HashSet<>(), getTimestamp());
	
	public BungeeTask()
	{
		this.start();
	}

	@SuppressWarnings("deprecation")
	@Override
	public void run()
	{
		// While true
		while (true)
		{
			// Useless.
			if (!run)
			{
				stop();
				return;
			}
			// Waiting
			try {
				keepAlive();
				sleep(1000);
			} catch (InterruptedException exception) {
				exception.printStackTrace();
			}
		}
	}
	
	public static long getTimestamp()
	{
		return System.currentTimeMillis() + 30_000;
	}
	
	public static String getIP()
	{
		return BungeeCord.getInstance().config.getListeners().iterator().next().getHost().getAddress().getHostAddress();
	}
	
	public static void keepAlive()
	{
		BadBungee badBungee = BadBungee.getInstance();
		Set<String> playerNames = badBungee.getProxy().getPlayers().parallelStream().map(player -> player.getName()).collect(Collectors.toSet());
		bungeeObject.refresh(playerNames);
		Gson gson = badBungee.getGson();
		String jsonFormatString = gson.toJson(bungeeObject);
		badBungee.getRabbitService().sendPacket(new RabbitPacket(new RabbitPacketMessage(5000, jsonFormatString), 
				BadBungeeQueues.BUNGEE_DATA, false, RabbitPacketEncoder.UTF8, RabbitPacketType.PUBLISHER));
	}

}
