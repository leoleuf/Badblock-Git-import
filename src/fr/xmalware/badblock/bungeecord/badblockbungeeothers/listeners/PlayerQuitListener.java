package fr.xmalware.badblock.bungeecord.badblockbungeeothers.listeners;

import fr.badblock.commons.technologies.rabbitmq.RabbitPacketType;
import fr.badblock.commons.utils.Encodage;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.BadBlockBungeeOthers;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.Player;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.BadblockDatabase;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request.RequestType;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import net.md_5.bungee.api.event.PlayerDisconnectEvent;
import net.md_5.bungee.api.plugin.Listener;
import net.md_5.bungee.event.EventHandler;

public class PlayerQuitListener implements Listener {
	
	@EventHandler
	public void onPlayerDisconnect(PlayerDisconnectEvent event) {
		ProxiedPlayer proxiedPlayer = event.getPlayer();
		Player player = Player.get(proxiedPlayer);
		BadBlockBungeeOthers.getInstance().getRabbitService().sendPacket("quit", proxiedPlayer.getName(), Encodage.UTF8, RabbitPacketType.PUBLISHER, 5000, false);
		BadblockDatabase.getInstance().addRequest(new Request("UPDATE cheatReports SET lastLogin = '0' WHERE pseudo = '" + BadblockDatabase.getInstance().mysql_real_escape_string(proxiedPlayer.getName()) + "'", RequestType.SETTER));
		player.remove();
	}

}
