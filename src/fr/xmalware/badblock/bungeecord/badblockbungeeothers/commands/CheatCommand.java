package fr.xmalware.badblock.bungeecord.badblockbungeeothers.commands;

import java.sql.ResultSet;

import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.BadblockDatabase;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request.RequestType;
import net.md_5.bungee.api.CommandSender;
import net.md_5.bungee.api.plugin.Command;

public class CheatCommand extends Command {

	public CheatCommand() {
		super("cheat");
	}

	@SuppressWarnings("deprecation")
	public void execute(CommandSender sender, String[] args) {
		if (args.length != 1) {
			sender.sendMessage("§cUtilisation: /cheat <pseudo>");
			return;
		}
		String playerName = args[0];
		if (playerName.equalsIgnoreCase(sender.getName())) {
			sender.sendMessage("§cVous ne pouvez pas vous rapporter vous-même. Avez-vous un trouble de la personnalité ?");
			return;
		}
		BadblockDatabase.getInstance().addSyncRequest(new Request("SELECT * FROM friends WHERE pseudo = '" + BadblockDatabase.getInstance().mysql_real_escape_string(playerName) + "'", RequestType.GETTER) {
			@Override
			public void done(ResultSet resultSet) {
				try {
					if (resultSet.next()) {
						BadblockDatabase.getInstance().addSyncRequest(new Request("SELECT COUNT(*) AS count FROM cheatReports WHERE pseudo = '" + BadblockDatabase.getInstance().mysql_real_escape_string(playerName) + "' AND byPlayer = '" + BadblockDatabase.getInstance().mysql_real_escape_string(sender.getName()) + "' AND timestamp > '" + System.currentTimeMillis() + "'", RequestType.GETTER) {
							@Override
							public void done(ResultSet resultSet) {
								try {
									if (resultSet.next()) {
										int count = resultSet.getInt("count");
										if (count == 0) {
											// Il peut report pour cheat
											BadblockDatabase.getInstance().addSyncRequest(new Request("INSERT INTO cheatReports(pseudo, byPlayer, timestamp) VALUES('" + BadblockDatabase.getInstance().mysql_real_escape_string(playerName) + "', '" + BadblockDatabase.getInstance().mysql_real_escape_string(sender.getName()) + "', '" + (System.currentTimeMillis() + 86400000) + "')", RequestType.SETTER));
											sender.sendMessage("§aVous avez signalé ce joueur. Les modérateurs vérifieront votre signalement prochainement.");
										}else{
											sender.sendMessage("§cVous avez déjà signalé ce joueur ces dernières 24 heures.");
										}
									}else{
										sender.sendMessage("§cErreur.");
									}
								}catch(Exception error2) {
									error2.printStackTrace();
								}
							}
						});
					}else{
						sender.sendMessage("§cCe joueur n'existe pas.");
					}
				}catch(Exception error) {
					error.printStackTrace();
				}
			}
		});
	}

}