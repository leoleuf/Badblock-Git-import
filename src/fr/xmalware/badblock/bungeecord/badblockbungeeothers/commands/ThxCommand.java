package fr.xmalware.badblock.bungeecord.badblockbungeeothers.commands;

import java.lang.reflect.Type;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Random;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.reflect.TypeToken;

import fr.badblock.commons.technologies.rabbitmq.RabbitPacketType;
import fr.badblock.commons.utils.Encodage;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.BadBlockBungeeOthers;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.BadblockDatabase;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request.RequestType;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.tmputils.PlayerBooster;
import net.md_5.bungee.api.CommandSender;
import net.md_5.bungee.api.plugin.Command;

public class ThxCommand extends Command {

	private static final Type type = new TypeToken<Map<String, PlayerBooster>>() {}.getType();
	private static final Gson gson = new GsonBuilder().setPrettyPrinting().create();

	public ThxCommand() {
		super("thx");
	}

	public void execute(CommandSender sender, String[] args) {
		BadblockDatabase.getInstance().addRequest(new Request("SELECT value FROM keyValues WHERE `key` = 'booster'", RequestType.GETTER) {

			@SuppressWarnings("deprecation")
			@Override
			public void done(ResultSet result) {
				try {
					result.next();
					String value = result.getString("value");
					Map<String, PlayerBooster> updatedMap = gson.fromJson(value, type);
					sender.sendMessage("§8------------------------------------------------");
					StringBuilder o = new StringBuilder();
					for (Entry<String, PlayerBooster> entry : updatedMap.entrySet()) {
						if (!entry.getValue().isEnabled() || !entry.getValue().isValid()) continue;
						BadblockDatabase.getInstance().addSyncRequest(new Request("SELECT playerName FROM boosterThanks WHERE expire = '" + entry.getValue().getExpire() + "' AND playerName = '" + sender.getName().toLowerCase() + "'", RequestType.GETTER) {
							@Override
							public void done(ResultSet result) {
								try {
									if (result.next()) {
										sender.sendMessage("§6➤ [" + entry.getValue().getGameName().toUpperCase() + "] §f➠ §e" + entry.getValue().getUsername() + " §6: §cRemerciement déjà apporté");
									}else{
										double randomBadcoins = new Random().nextInt((int) (entry.getValue().getBooster().getMaxRandomBadcoins() - entry.getValue().getBooster().getMinRandomBadcoins())) + entry.getValue().getBooster().getMinRandomBadcoins();
										double randomXP = new Random().nextInt((int) (entry.getValue().getBooster().getMaxRandomXp() - entry.getValue().getBooster().getMinRandomXp())) + entry.getValue().getBooster().getMinRandomXp();
										if (entry.getValue().getAddedBadcoins() >= entry.getValue().getBooster().getMaxBadcoins()) randomBadcoins = 0;
										if (entry.getValue().getAddedXp() >= entry.getValue().getBooster().getMaxXP()) randomXP = 0;
										if (randomXP != 0 || randomBadcoins != 0) {
											BadblockDatabase.getInstance().addSyncRequest(new Request("INSERT INTO boosterThanks(playerName, expire) VALUES('" + sender.getName().toLowerCase() + "', '" + entry.getValue().getExpire() + "')", RequestType.SETTER));
											BadblockDatabase.getInstance().addSyncRequest(new Request("INSERT INTO debts(playerName, xp, badcoins) VALUES('" + entry.getValue().getUsername().toLowerCase() + "', '" + randomXP + "', '" + randomBadcoins + "')", RequestType.SETTER));
											sender.sendMessage("§6➤ [" + entry.getValue().getGameName().toUpperCase() + "] §f➠ §e" + entry.getValue().getUsername() + " §6: §6+" + (int) randomBadcoins + " BadCoin" + (randomBadcoins > 1 ? "s" : "") + " §7& §3+" + (int) randomXP + " XP");
											double randomBadcoinsPlayer = new Random().nextInt(3) + 2;
											double randomXPPlayer = new Random().nextInt(2) + 2;
											if (o.length() == 0) {
												BadblockDatabase.getInstance().addSyncRequest(new Request("INSERT INTO debts(playerName, xp, badcoins) VALUES('" + sender.getName().toLowerCase() + "', '" + randomXPPlayer + "', '" + randomBadcoinsPlayer + "')", RequestType.SETTER));
												o.append("§a➤ Vous avez gagné §6+" + (int) randomBadcoinsPlayer + " BadCoin" + (randomBadcoinsPlayer > 1 ? "s" : "") + " §7& §3+" + (int) randomXPPlayer + " XP §asuite à votre reconnaissance envers les personnes ayant des Boosters activés (ils vont apparaître sur votre compte dans quelques minutes).");
												if (!entry.getValue().getUsername().toLowerCase().equalsIgnoreCase(sender.getName().toLowerCase())) {
													BadBlockBungeeOthers.getInstance().getRabbitService().sendPacket("playerMessage", entry.getValue().getUsername() + ";§f[§dBadCoins§f] §e" + sender.getName() + " §7vous a remercié ! §6+" + (int) randomBadcoins + " BadCoin" + (randomBadcoins > 1 ? "s" : "") + " §7& +§3" + (int) randomXP + " XP", Encodage.UTF8, RabbitPacketType.PUBLISHER, 100000, false);
												}else{
													BadBlockBungeeOthers.getInstance().getRabbitService().sendPacket("playerMessage", entry.getValue().getUsername() + ";§f[§dBadCoins§f] §7Vous vous êtes remercié :o §6+" + (int) randomBadcoins + " BadCoin" + (randomBadcoins > 1 ? "s" : "") + " §7& +§3" + (int) randomXP + " XP", Encodage.UTF8, RabbitPacketType.PUBLISHER, 100000, false);
												}
											}
										}else{
											sender.sendMessage("§6➤ [" + entry.getValue().getGameName().toUpperCase() + "] §f➠ §e" + entry.getValue().getUsername() + " §6: §cMaximum atteint §6" + (int) entry.getValue().getBooster().getMaxBadcoins() + " BadCoin" + (entry.getValue().getBooster().getMaxBadcoins() > 1 ? "s" : "") + " §c& §3" + (int) entry.getValue().getBooster().getMaxXP() + " XP");
										}
									}
								} catch (SQLException e) {
									e.printStackTrace();
								}
							}
						});

					}
					sender.sendMessage("§8------------------------------------------------");
					if (o.length() > 0) {
						sender.sendMessage(o.toString());
						sender.sendMessage("§8------------------------------------------------");
					}
					result.close(); // don't forget to close it
				} catch (Exception exception) {
					exception.printStackTrace();
				}
			}

		});
	}

}