package fr.xmalware.badblock.bungeecord.badblockbungeeothers.modules;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

import com.google.gson.Gson;

import fr.badblock.commons.technologies.rabbitmq.RabbitPacketType;
import fr.badblock.commons.utils.Encodage;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.BadBlockBungeeOthers;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.Player;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.BadblockDatabase;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.database.Request.RequestType;
import fr.xmalware.badblock.bungeecord.badblockbungeeothers.modules.abstracts.Module;
import net.md_5.bungee.api.connection.Connection;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import net.md_5.bungee.api.event.ChatEvent;
import net.md_5.bungee.config.Configuration;
import net.md_5.bungee.config.ConfigurationProvider;
import net.md_5.bungee.config.YamlConfiguration;
import net.md_5.bungee.event.EventHandler;
import net.md_5.bungee.event.EventPriority;

public class BadInsultModule extends Module {

	public static BadInsultModule	instance	= null;

	public  List<String> insultsList 			= new ArrayList<>();
	public  List<String> insultsMuteList 		= new ArrayList<>();
	private List<String> antiSpam				= new ArrayList<>();
	private List<String> insultError			= new ArrayList<>();
	private List<String> antiFlood				= new ArrayList<>();
	private long		 timeBetweenEachMessage = 1000L;
	private long		 timeBetweenSameMessage = 60000L;
	private List<String> commands				= new ArrayList<>();

	public BadInsultModule() {
		instance = this;
		Configuration configuration = BadBlockBungeeOthers.getInstance().getConfiguration();
		boolean changed = false;
		if (configuration.get("modules.badInsult.insults") == null) {
			insultsList.add("tg");
			configuration.set("modules.badInsult.insults", insultsList);
			changed = true;
		}
		if (configuration.get("modules.badInsult.insultsmute") == null) {
			insultsMuteList.add("tg");
			configuration.set("modules.badInsult.insultsmute", insultsMuteList);
			changed = true;
		}
		if (configuration.get("modules.spam.antiSpam") == null) {
			configuration.set("modules.spam.antiSpam", antiSpam);
			changed = true;
		}
		if (configuration.get("modules.spam.antiFlood") == null) {
			configuration.set("modules.spam.antiFlood", antiFlood);
			changed = true;
		}
		if (configuration.get("modules.spam.timeBetweenEachMessage") == null) {
			configuration.set("modules.spam.timeBetweenEachMessage", timeBetweenEachMessage);
			changed = true;
		}
		if (configuration.get("modules.spam.timeBetweenSameMessage") == null) {
			configuration.set("modules.spam.timeBetweenSameMessage", timeBetweenSameMessage);
			changed = true;
		}
		/*if (configuration.get("modules.badInsult.insultError") == null) {
			configuration.set("modules.badInsult.insultError", insultError);
			changed = true;
		}*/
		if (configuration.get("modules.badInsult.onlyForCommands") == null) {
			/*
			 * 	/*if (!message.startsWith("msg") && !message.startsWith("whisper") && !message.startsWith("m") && !message.startsWith("w") && !message.startsWith("tellraw") 
				&& !message.startsWith("tell") && !message.startsWith("minecraft:tell") && !message.startsWith("message:tellraw") && 
				!message.startsWith("minecraft:whisper") && !message.startsWith("minecraft:w") && !message.startsWith("r")) return;
			 */
			commands.add("msg");
			commands.add("whisper");
			commands.add("m");
			commands.add("w");
			commands.add("tellraw");
			commands.add("tell");
			commands.add("minecraft:tell");
			commands.add("minecraft:tellraw");
			commands.add("minecraft:whisper");
			commands.add("minecraft:w");
			commands.add("r");
			configuration.set("modules.badInsult.onlyForCommands", commands);
			changed = true;
		}
		if (changed) {
			try {
				ConfigurationProvider.getProvider(YamlConfiguration.class).save(configuration, new File(BadBlockBungeeOthers.getInstance().getDataFolder(), "config.yml"));
			} catch (IOException e) {
				e.printStackTrace();
			}	
			try {
				configuration = ConfigurationProvider.getProvider(YamlConfiguration.class).load(new File(BadBlockBungeeOthers.getInstance().getDataFolder(), "config.yml"));
				BadBlockBungeeOthers.getInstance().setConfiguration(configuration);
			} catch (IOException e) {
				e.printStackTrace();
			}
		}
		insultsList = configuration.getStringList("modules.badInsult.insults");
		List<String> temporary = new ArrayList<>();
		insultsList.forEach(insult -> temporary.add(applyFilter(insult)));
		insultsList = temporary;
		List<String> temporarye = new ArrayList<>();
		insultsMuteList = configuration.getStringList("modules.badInsult.insultsmute");
		insultsMuteList.forEach(insult -> temporarye.add(applyFilter(insult)));
		insultsMuteList = temporarye;
		antiSpam = configuration.getStringList("modules.spam.antiSpam");
		antiFlood = configuration.getStringList("modules.spam.antiFlood");
		insultError = configuration.getStringList("modules.badInsult.insultError");
		commands = configuration.getStringList("modules.badInsult.onlyForCommands");
		timeBetweenEachMessage = configuration.getLong("modules.spam.timeBetweenEachMessage");
		timeBetweenSameMessage = configuration.getLong("modules.spam.timeBetweenSameMessage");
	}
	public SimpleDateFormat simpleDateFormat = new SimpleDateFormat("dd/M/yyyy HH:mm:ss");

	@SuppressWarnings({ "deprecation", "static-access" })
	@EventHandler (priority = EventPriority.HIGHEST)
	public void onAsyncChat(ChatEvent event) {
		Connection sender = event.getSender();
		if (!(sender instanceof ProxiedPlayer)) return;
		ProxiedPlayer player = (ProxiedPlayer) sender;
		if (player.hasPermission("chat.bypass")) return;
		fr.badblock.ladder.bungee.Player pl = fr.badblock.ladder.bungee.LadderBungee.getInstance().getPlayer(player.getName());
		if (pl.getPunished().isMute() || pl.getPunished().getMuteEnd() > System.currentTimeMillis()) return;
		String message = event.getMessage();
		if (message.startsWith("/")) {
			boolean bypass = true;
			for (String command : commands) {
				if (message.startsWith("/" + command + " ")) {
					bypass = false;
					break;
				}
			}
			if (bypass) return;
		}

		//if (event.isCommand()) return;
		// Réécriture du message sans doublons
		// plus ou égal à trois choses
		int nb = 0;
		String filteredMessage = applyFilter(message);
		Character lastCharacter = null;
		int upperCase = 0;
		String okMessage = "";
		for (Character character : message.toCharArray()) {
			if (lastCharacter != null && character.toString().equals(lastCharacter.toString()) && (lastCharacter.toString().equals("!") || lastCharacter.toString().equals("?"))) {
				nb++;
				if (nb >= 2 && (lastCharacter.toString().equals("!") || lastCharacter.toString().equals("?"))) {
					if (nb == 2) {
						if (lastCharacter.toString().equals("w")) {
							continue;
						}
					}
					player.sendMessage(BadBlockBungeeOthers.getInstance().getMessage(antiFlood));
					event.setCancelled(true);
					return;
				}
			}else{
				nb = 0;
				if (character.isUpperCase(character)) {
					if (upperCase >= 5) {
						character = character.toLowerCase(character);
					}
					upperCase++;
				}
			}
			lastCharacter = character;
			okMessage += character.toString();
		}
		message = okMessage;
		// Test d'insultes
		for (String insult : insultsList) {
			if (filteredMessage.contains(insult) || filteredMessage.equalsIgnoreCase(insult)) {
				//event.setCancelled(true);
				BadBlockBungeeOthers.getInstance().getRabbitService().sendPacket("badfilter", "§7" + player.getName() + " §8» §7" + message, Encodage.UTF8, RabbitPacketType.PUBLISHER, 5000, false);
				//player.sendMessage(BadBlockBungeeOthers.getInstance().getMessage(this.insultError));
				break;
			}
		}
		for (String insult : insultsMuteList) {
			if ((!insult.contains("*") && (filteredMessage.contains(insult) || filteredMessage.equalsIgnoreCase(insult))) ||
					(insult.contains("*") && ((event.getMessage().contains(" " + insult + " ") || event.getMessage().startsWith(insult + " ") || event.getMessage().endsWith(" " + insult))))) {
				event.setCancelled(true);
				Sanction sanction = new Sanction(player.getName(), "mute", System.currentTimeMillis() + 3600_000L, System.currentTimeMillis(), "nv1_2", "Guardian", "127.0.0.1", message, true);
				BadBlockBungeeOthers.getInstance().getRabbitService().sendPacket("sanction", new Gson().toJson(sanction), Encodage.UTF8, RabbitPacketType.MESSAGE_BROKER, 5000, false);
				player.sendMessage(BadBlockBungeeOthers.getInstance().getMessage(this.insultError));
				BadBlockBungeeOthers.getInstance().getRabbitService().sendPacket("badfilter", "§c[MUTED BY GUARDIAN] §7" + player.getName() + " §8» §7" + message, Encodage.UTF8, RabbitPacketType.PUBLISHER, 5000, false);
				BadblockDatabase.getInstance().addRequest(new Request(
						"INSERT INTO sanctions(pseudo, ip, type, expire, timestamp, date, reason, banner, fromIp, proof) "
								+ "VALUES('" + BadblockDatabase.getInstance().mysql_real_escape_string(player.getName())
								+ "', '"
								+ BadblockDatabase.getInstance()
										.mysql_real_escape_string(player.getAddress().getHostString())
								+ "', '" + BadblockDatabase.getInstance().mysql_real_escape_string("mute") + "', '"
								+ pl.getPunished().getMuteEnd() + "', '" + System.currentTimeMillis() + "', '"
								+ simpleDateFormat.format(new Date(System.currentTimeMillis()))
								+ "', '" + BadblockDatabase.getInstance().mysql_real_escape_string(pl.getPunished().getMuteReason()) + "', '"
								+ BadblockDatabase.getInstance().mysql_real_escape_string(pl.getPunished().getMuter()) + "', '"
								+ BadblockDatabase.getInstance().mysql_real_escape_string("127.0.0.1") + "', '"
								+ BadblockDatabase.getInstance().mysql_real_escape_string(message) + "')",
						RequestType.SETTER));
				return;
			}
		}
		if (BadCommunitySpookerModule.getInstance().testSpooking(player, event)) return;
		// Test de publicité
		String filteredWithoutDotMessage = message.toLowerCase().replaceAll("[^\\w.]+", "").replace(" ", "").replace("_", "");
		BadAdvertsModule.getInstance().testAdvert(player, event, filteredMessage, filteredWithoutDotMessage);
		Player playerO = Player.get(player);
		if (!event.isCancelled()) {
			if (playerO.getLastMessage() != null && playerO.getLastMessageTime() > System.currentTimeMillis()) {
				event.setCancelled(true);
				player.sendMessage(BadBlockBungeeOthers.getInstance().getMessage(this.antiFlood) + "!");
				return;
			}
			if (playerO.getSpamMessages().containsKey(filteredMessage)) {
				long time = playerO.getSpamMessages().get(filteredMessage);
				if (time > System.currentTimeMillis()) {
					event.setCancelled(true);
					player.sendMessage(BadBlockBungeeOthers.getInstance().getMessage(this.antiSpam));
					return;
				}
			}
		}
		playerO.getSpamMessages().put(filteredMessage, System.currentTimeMillis() + timeBetweenSameMessage);
		playerO.setLastMessageTime(System.currentTimeMillis() + timeBetweenEachMessage);
		playerO.setLastMessage(filteredMessage);
		event.setMessage(message);
	}

	public String applyFilter(String string) {
		string = string.toLowerCase().replaceAll("\\W", "").replace(" ", "").replace("_", "");
		String o = "";
		Character lastCharacter = null;
		for (Character character : string.toCharArray()) {
			if (lastCharacter == null || !lastCharacter.toString().equals(character.toString())) 
				o += character.toString();
			lastCharacter = character;
		}
		string = o;
		return o;
	}

}
