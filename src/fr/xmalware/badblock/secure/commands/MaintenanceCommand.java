package fr.xmalware.badblock.secure.commands;

import java.io.File;
import java.io.IOException;
import java.util.List;

import fr.badblock.ladder.api.Ladder;
import fr.badblock.ladder.api.chat.Motd;
import fr.badblock.ladder.api.commands.Command;
import fr.badblock.ladder.api.config.ConfigurationProvider;
import fr.badblock.ladder.api.config.YamlConfiguration;
import fr.badblock.ladder.api.entities.BungeeCord;
import fr.badblock.ladder.api.entities.CommandSender;
import fr.badblock.ladder.api.entities.Player;
import fr.badblock.ladder.api.utils.FileUtils;
import fr.xmalware.badblock.secure.BadBlockSecure;
import fr.xmalware.badblock.secure.i18n.I18N;

public class MaintenanceCommand extends Command {
	
	public static  String 		 prefix 				 = "§4§l[Alerte] §f";
	
	public MaintenanceCommand() {
		super ("maintenance", null, "mn");
	}
	
	@Override
	public void executeCommand(CommandSender sender, String[] args) {
		if (!sender.hasPermission("badblock.maintenance") && !sender.hasPermission("others.maintenance")) {
			sender.sendMessage(I18N.getTranslatedMessage("commands.permission"));
			return;
		}
		if (!BadBlockSecure.getInstance().maintenanceEnabled) {
			BadBlockSecure.getInstance().maintenanceEnabled = true;
			Motd motd = (Motd)FileUtils.load(new File("motd.json"), Motd.class);
			motd.setMotd(I18N.getTranslatedMessages("maintenance.motd"));
			List<String> strings = BadBlockSecure.getInstance().configuration.getStringList("lang.maintenance.players");
			String[] str = new String[] {};
			str = strings.toArray(str);
			motd.setPlayers(str);
			motd.setMaxPlayers(BadBlockSecure.getInstance().configuration.getInt("lang.maintenance.maxplayers"));
			motd.setVersion(BadBlockSecure.getInstance().configuration.getString("lang.maintenance.version"));
			Ladder.getInstance().getMotd().setMaxPlayers(motd.getMaxPlayers());
			Ladder.getInstance().getMotd().setMotd(motd.getMotd());
			Ladder.getInstance().getMotd().setPlayers(motd.getPlayers());
			Ladder.getInstance().getMotd().setVersion(motd.getVersion());
			for (BungeeCord bungee : Ladder.getInstance().getServers()) {
				bungee.sendMotd(motd);
			}
			sender.sendMessages(I18N.getTranslatedMessages("maintenance.true_message"));
			Ladder.getInstance().broadcast(I18N.getTranslatedMessages("maintenance.true_broadcast"));
			BadBlockSecure.getInstance().configuration.set("maintenance.enabled", true);
			try {
				ConfigurationProvider.getProvider(YamlConfiguration.class).save(BadBlockSecure.getInstance().configuration, BadBlockSecure.getInstance().configFile);
			} catch (IOException e) {
				e.printStackTrace();
			}
			for (Player player : BadBlockSecure.getInstance().getLadder().getOnlinePlayers()) {
				if (player.getBukkitServer() != null && player.getBukkitServer().getName().startsWith("lobby") && !player.hasPermission("badblock.maintenance.bypass")) {
					player.disconnect(BadBlockSecure.getInstance().maintenanceConnection);
				}
			}
			return;
		}
		BadBlockSecure.getInstance().maintenanceEnabled = false;
		
		Motd motd = (Motd)FileUtils.load(new File("motd.json"), Motd.class);
		Ladder.getInstance().getMotd().setMotd(motd.getMotd());
		Ladder.getInstance().getMotd().setPlayers(motd.getPlayers());
		Ladder.getInstance().getMotd().setMaxPlayers(motd.getMaxPlayers());
		Ladder.getInstance().getMotd().setVersion(motd.getVersion());
		for (BungeeCord bungee : Ladder.getInstance().getServers()) {
			bungee.sendMotd(Ladder.getInstance().getMotd());
		}
		
		sender.sendMessages(I18N.getTranslatedMessages("maintenance.false_message"));
		BadBlockSecure.getInstance().configuration.set("maintenance.enabled", false);
		try {
			ConfigurationProvider.getProvider(YamlConfiguration.class).save(BadBlockSecure.getInstance().configuration, BadBlockSecure.getInstance().configFile);
		} catch (IOException e) {
			e.printStackTrace();
		}
		Ladder.getInstance().broadcast(I18N.getTranslatedMessages("maintenance.false_broadcast"));
	}
	
}
