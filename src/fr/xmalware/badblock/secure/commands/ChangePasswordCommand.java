package fr.xmalware.badblock.secure.commands;

import java.util.Timer;
import java.util.TimerTask;

import com.google.gson.JsonObject;

import fr.badblock.ladder.api.commands.Command;
import fr.badblock.ladder.api.entities.CommandSender;
import fr.badblock.ladder.api.entities.Player;
import fr.xmalware.badblock.secure.BadBlockSecure;

public class ChangePasswordCommand extends Command {

	public ChangePasswordCommand() {
		super ("changepass", null, "changepassword", "mdp");
	}

	@Override
	public void executeCommand(CommandSender sender, String[] args) {
		if (!(sender instanceof Player)) {
			sender.sendMessage("§cVous devez être un joueur pour pouvoir exécuter cette commande.");
			return;
		}
		if (args.length != 2) {
			sender.sendMessage("§cUsage: /mdp <mot de passe actuel> <nouveau mot de passe>");
			return;
		}
		String actualPassword = args[0];
		String newPassword = args[1];
		Player player = (Player) sender;
		JsonObject jsonObject = player.getData();
		String loginPassword = jsonObject.get("loginPassword").getAsString();
		try {
			if (!BadBlockSecure.getInstance().getHasher().comparePassword(loginPassword, actualPassword)) {
				sender.sendMessage("§cVotre mot de passe actuel ne correspond pas.");
				return;
			}
			if (newPassword.length() < 6) {
				sender.sendMessage("§cVotre nouveau mot de passe est trop petit.");
				return;	
			}
			JsonObject obj = new JsonObject();
			obj.addProperty("loginPassword", BadBlockSecure.getInstance().getHasher().getHash(newPassword));
			player.updateData(obj);
			new Timer().schedule(new TimerTask() {
				@Override
				public void run() {
					player.saveData();
				}
			}, 1000);
			player.sendToBungee("loginPassword");
			player.sendToBukkit("loginPassword");
			sender.sendMessage("§aVotre nouveau mot de passe a bien été changé.");
		}catch(Exception error) {
			error.printStackTrace();
		}
	}

}
