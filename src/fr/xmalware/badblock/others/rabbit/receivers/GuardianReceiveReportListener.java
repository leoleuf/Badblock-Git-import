package fr.xmalware.badblock.others.rabbit.receivers;

import java.awt.TextComponent;
import java.util.ArrayList;
import java.util.List;

import com.google.gson.Gson;

import fr.badblock.ladder.api.Ladder;
import fr.badblock.ladder.api.chat.RawMessage;
import fr.badblock.ladder.api.chat.RawMessage.ClickEventType;
import fr.badblock.ladder.api.chat.RawMessage.HoverEventType;
import fr.badblock.ladder.api.entities.BungeeCord;
import fr.badblock.ladder.api.entities.Player;
import fr.xmalware.badblock.docker.server.rabbitmq.listeners.abstracts.PacketListener;
import fr.xmalware.badblock.docker.server.rabbitmq.utils.RabbitQueue;
import fr.xmalware.badblock.others.guardian.GuardianReport;

public class GuardianReceiveReportListener extends PacketListener {

	public GuardianReceiveReportListener() {
		super("guardian.report", false);
	}

	@Override
	public void onPacketReceive(String string) {
		GuardianReport guardianReport = new Gson().fromJson(string, GuardianReport.class);
		String server = "Inconnu";
		Player player = Ladder.getInstance().getPlayer(guardianReport.getUniqueId());
		if (player != null) server = player.getBukkitServer().getName();
		RawMessage component = getMessage(guardianReport.getMessage().replace("[SERVER]", server), "Cliquez pour vous téléporter au joueur");
		component.setClickEvent(ClickEventType.RUN_COMMAND, false, "/connect player:" + player.getName());
		Ladder.getInstance().getConsoleCommandSender().sendMessage(guardianReport.getMessage().replace("[SERVER]", server));
		Ladder.getInstance().getOnlinePlayers().parallelStream().filter(pl -> pl.getBukkitServer() != null && !pl.getBukkitServer().getName().startsWith("login") && pl.hasPermission("guardian.modo")).forEach(pl -> component.send(pl));
	}

	public RawMessage getMessage(String message, String lore) {
		// Envoi du message au joueur
		RawMessage rawMessage = Ladder.getInstance().createRawMessage(message);
		// Ajout du lore
		if (!"".equals(lore)) {
			String[] lines = lore.split("\n");
			List<String> components = new ArrayList<>();
			int i = 0;
			for (String line : lines) {
				i++;
				String addon = i != lines.length ? "\n" : "";
				components.add(line);
			}
			String[] arr = new String[] {};
			arr = components.toArray(arr);
			rawMessage.setHoverEvent(HoverEventType.SHOW_TEXT, false, arr);
		}
		return rawMessage;
	}
	
}
