package fr.xmalware.badblock.others.rabbit.receivers;

import java.util.Date;

import com.google.gson.Gson;

import fr.badblock.ladder.api.Ladder;
import fr.badblock.ladder.api.entities.Player;
import fr.badblock.ladder.api.utils.Punished;
import fr.badblock.rabbitconnector.RabbitConnector;
import fr.badblock.rabbitconnector.RabbitListener;
import fr.badblock.rabbitconnector.RabbitListenerType;
import fr.xmalware.badblock.others.BadBlockOthers;
import fr.xmalware.badblock.others.database.BadblockDatabase;
import fr.xmalware.badblock.others.database.Request;
import fr.xmalware.badblock.others.database.Request.RequestType;
import fr.xmalware.badblock.others.guardian.GuardianKick;

public class GuardianReceiveBanListener extends RabbitListener {

	public GuardianReceiveBanListener() {
		super(RabbitConnector.getInstance().getService("default"), "guardian.ban", false,
				RabbitListenerType.MESSAGE_BROKER);
	}

	@Override
	public void onPacketReceiving(String string) {
		GuardianKick kick = new Gson().fromJson(string, GuardianKick.class);
		Player proxiedPlayer = Ladder.getInstance().getPlayer(kick.getUniqueId());
		if (proxiedPlayer != null) {
			// Add punishment
			String ip = proxiedPlayer.getLastAddress().getHostAddress();
			punish(proxiedPlayer.getAsPunished(), kick.getReason());
			punish(proxiedPlayer.getIpAsPunished(), kick.getReason());
			proxiedPlayer.savePunishions();
			proxiedPlayer.getIpData().savePunishions();
			proxiedPlayer.disconnect(kick.getMessage());
			BadblockDatabase.getInstance()
					.addRequest(new Request(
							"INSERT INTO sanctions(pseudo, ip, type, expire, timestamp, date, reason, banner, fromIp) "
									+ "VALUES('"
									+ BadblockDatabase.getInstance().mysql_real_escape_string(proxiedPlayer.getName())
									+ "', '" + BadblockDatabase.getInstance().mysql_real_escape_string(ip)
									+ "', 'btempban', '" + (System.currentTimeMillis() + (86400_000 * 5L)) + "', '"
									+ System.currentTimeMillis() + "', '"
									+ BadblockDatabase.getInstance().mysql_real_escape_string(
											BadBlockOthers.getInstance().simpleDateFormat.format(new Date()))
									+ "', '" + BadblockDatabase.getInstance().mysql_real_escape_string(kick.getReason())
									+ "', 'Guardian', '127.0.0.1')",
							RequestType.SETTER));
		}
	}

	private void punish(Punished punished, String kickReason) {
		punished.setBan(true);
		punished.setBanEnd(System.currentTimeMillis() + (86400_000 * 5L));
		punished.setBanner("Guardian");
		punished.setBanReason(kickReason);
	}

}
