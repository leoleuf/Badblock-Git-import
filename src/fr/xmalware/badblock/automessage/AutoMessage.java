package fr.xmalware.badblock.automessage;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.util.Timer;
import java.util.TimerTask;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;

import fr.badblock.ladder.api.Ladder;
import fr.badblock.ladder.api.plugins.Plugin;
import fr.badblock.ladder.api.plugins.PluginsManager;
import lombok.Getter;
import lombok.Setter;

@Getter @Setter public class AutoMessage extends Plugin {

	@Getter @Setter private static AutoMessage	instance;
	
	private Gson 								gson;
	private AutoMessageConfig					configuration;
	private long								seconds;
	
	@Override
	public void onEnable() {
		setInstance(this);
		Ladder ladder = Ladder.getInstance();
		PluginsManager pluginsManager = ladder.getPluginsManager();
		pluginsManager.registerCommand(this, new AutoMessageCommand());
		this.reloadConfiguration();
		GsonBuilder gsonBuilder = new GsonBuilder().setPrettyPrinting().excludeFieldsWithoutExposeAnnotation();
		this.setGson(gsonBuilder.create());
		Timer timer = new Timer();
		timer.schedule(new TimerTask() {
			@Override
			public void run() {
				if (getSeconds() == -1) return;
				setSeconds(getSeconds() + 1);
				getConfiguration().getInsistentMessages().stream().filter(insistentMessage -> insistentMessage.getEveryXSeconds() % getSeconds() == 0).forEach(insistentMessage -> ladder.broadcast(insistentMessage.getMessage()));
			}
		}, 1000, 1000);
	}
	
	public void reloadConfiguration() {
		this.setSeconds(-1);
		File folder = getDataFolder();
		if (!folder.exists()) folder.mkdirs();
		File file = new File(getDataFolder(), "config.json");
		if (!file.exists())
			try {
				file.createNewFile();
			} catch (IOException exception) {
				exception.printStackTrace();
			}
		String o = "";
		try {
			try (BufferedReader br = new BufferedReader(new FileReader(file))) {
				String line;
				while ((line = br.readLine()) != null) {
					o += line;
				}
			}
		} catch (IOException exception) {
			exception.printStackTrace();
		}
		AutoMessageConfig autoMessageConfig = this.getGson().fromJson(o, AutoMessageConfig.class);
		setConfiguration(autoMessageConfig);
		this.setSeconds(0);
	}
	
}
